---
import { Picture } from 'astro:assets';
import type { ImageMetadata } from 'astro';
import { layoutTokens } from '../utils/layoutTokens';

interface Props {
	src: ImageMetadata;
	alt: string;
	index: number;
	class?: string;
}

const { src, alt, index, class: className } = Astro.props;
const isFirst = index === 0;
const { remBase, pageMaxRem, pagePadRem, comicGapRem } = layoutTokens;
const pageMaxPx = pageMaxRem * remBase;
const pagePadPx = pagePadRem * remBase;
const comicGapPx = comicGapRem * remBase;
const oneColMax = pageMaxPx - pagePadPx * 2;
const twoColMax = (pageMaxPx - pagePadPx * 2 - comicGapPx) / 2;
const maxWidth = src.width ?? oneColMax;
const widths = [360, 480, Math.round(twoColMax), Math.round(oneColMax)]
	.filter((width) => width <= maxWidth)
	.filter((width, i, list) => list.indexOf(width) === i)
	.sort((a, b) => a - b);
---

<div class="reveal-img">
	<Picture
		src={src}
		formats={['avif', 'webp']}
		widths={widths}
		sizes="(min-width: 768px) calc((min(100vw, var(--page-max)) - (var(--page-pad) * 2) - var(--comic-gap)) / 2), 100vw"
		alt={alt}
		loading={isFirst ? 'eager' : 'lazy'}
		fetchpriority={isFirst ? 'high' : undefined}
		class:list={['w-full h-auto outline outline-zinc-600', className]}
	/>
</div>

<style>
	.reveal-img picture {
		opacity: 0;
	}
</style>
